<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="theme-color" content="#080a0e">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>TRADER</title>
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;600;700&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#080a0e; --panel:#0d1017; --border:#1a2030;
  --green:#00e676; --red:#ff1744; --gold:#ffc400;
  --text:#f0f4ff; --dim:#4a5a70;
}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}

/* â”€â”€ ROOT LAYOUT: fixed full-screen column â”€â”€ */
html,body{
  width:100%; height:100%;
  background:var(--bg); overflow:hidden;
  font-family:'IBM Plex Mono',monospace;
  color:var(--text); user-select:none; cursor:crosshair;
}
#app{
  position:fixed; inset:0;
  display:flex; flex-direction:column;
}

/* â”€â”€ TOP BAR â”€â”€ */
#topbar{
  flex:0 0 auto;
  height:44px; background:var(--panel); border-bottom:1px solid var(--border);
  display:flex; align-items:center; justify-content:space-between;
  padding:0 10px; position:relative; z-index:10;
}
#timerFill{
  position:absolute; left:0; top:0; bottom:0;
  background:linear-gradient(90deg,#3a0000,#b91c1c,#ff4444);
  pointer-events:none; opacity:.7; transition:width .15s linear;
}
#timerFill.urgent{background:linear-gradient(90deg,#700,#f00,#ff6060);opacity:.9;}
#stockBadge{position:relative;z-index:2;display:flex;align-items:center;gap:8px;}
#stockTag{font-size:.82rem;font-weight:700;background:var(--gold);color:#000;padding:2px 8px;border-radius:3px;letter-spacing:.05em;}
#livePrice{font-size:.88rem;font-weight:700;color:#fff;}
#livePriceDelta{font-size:.72rem;font-weight:600;}
#topRight{position:relative;z-index:2;display:flex;align-items:center;gap:6px;}
#timerPill{
  font-size:.82rem;font-weight:700;color:#fff;
  background:#991b1b;padding:2px 10px;border-radius:3px;min-width:36px;text-align:center;
}
#timerPill.urgent{background:#dc2626;animation:pulse .5s ease-in-out infinite alternate;}
@keyframes pulse{from{opacity:1}to{opacity:.6}}
.ctrl-btn{
  font-family:'IBM Plex Mono',monospace;font-weight:700;
  letter-spacing:.06em;color:#fff;background:rgba(255,255,255,.08);
  border:1px solid var(--border);padding:3px 7px;border-radius:3px;
  cursor:pointer;white-space:nowrap;touch-action:manipulation;font-size:.62rem;
}
.ctrl-btn:active{background:rgba(255,255,255,.2);}
#pauseBtn.paused{background:rgba(255,196,0,.15);border-color:var(--gold);color:var(--gold);}

/* â”€â”€ HUD â”€â”€ */
#hud{
  flex:0 0 auto;
  display:flex;flex-direction:column;
  border-bottom:1px solid var(--border);
  background:var(--panel);
}
.hud-row{
  display:flex;overflow-x:auto;scrollbar-width:none;
  border-bottom:1px solid var(--border);
}
.hud-row:last-child{border-bottom:none;}
.hud-row::-webkit-scrollbar{display:none;}
.hud-cell{
  padding:4px 10px;border-right:1px solid var(--border);
  display:flex;flex-direction:column;gap:1px;flex-shrink:0;
}
.hud-cell:last-child{border-right:none;}
.hud-lbl{font-size:.48rem;letter-spacing:.1em;color:var(--dim);text-transform:uppercase;white-space:nowrap;}
.hud-val{font-size:.76rem;font-weight:700;color:#fff;white-space:nowrap;}
.hud-val.green{color:var(--green);}
.hud-val.red{color:var(--red);}

/* â”€â”€ CHARTS AREA: fills remaining space â”€â”€ */
#chartsArea{
  flex:1 1 0;
  display:flex;flex-direction:column;
  min-height:0; /* critical for flex children to shrink */
}
#mainWrap{
  flex:0 0 72%;
  position:relative;overflow:hidden;min-height:0;
}
#equityWrap{
  flex:0 0 28%;
  position:relative;overflow:hidden;min-height:0;
  border-top:1px solid var(--border);
}
canvas{display:block;width:100%;height:100%;touch-action:none;}
.chart-label{
  position:absolute;top:6px;left:10px;
  font-size:.6rem;font-weight:600;letter-spacing:.08em;
  color:var(--dim);text-transform:uppercase;pointer-events:none;
}
#tradeFlash{
  position:absolute;top:35%;left:50%;transform:translate(-50%,-50%);
  font-size:clamp(1.3rem,6vw,2.4rem);font-weight:700;letter-spacing:.2em;
  opacity:0;pointer-events:none;transition:opacity .08s;z-index:20;
  text-shadow:0 0 50px currentColor;
}
#holdingBar{
  position:absolute;bottom:38px;left:50%;transform:translateX(-50%);
  font-size:.65rem;font-weight:700;letter-spacing:.12em;
  padding:3px 12px;border-radius:2px;
  background:rgba(0,230,118,.12);border:1px solid var(--green);color:var(--green);
  opacity:0;pointer-events:none;transition:opacity .2s;z-index:15;white-space:nowrap;
}
#holdingBar.show{opacity:1;}
#hint{
  position:absolute;bottom:8px;left:50%;transform:translateX(-50%);
  font-size:.52rem;letter-spacing:.12em;color:#1e2d3d;
  pointer-events:none;z-index:10;white-space:nowrap;
}

/* â”€â”€ PAUSE OVERLAY â”€â”€ */
#pauseScreen{
  position:fixed;inset:0;z-index:80;background:rgba(4,6,10,.85);
  display:flex;flex-direction:column;align-items:center;justify-content:center;gap:16px;
  opacity:0;pointer-events:none;transition:opacity .2s;
}
#pauseScreen.show{opacity:1;pointer-events:all;}
#pauseScreen h2{font-size:clamp(1.4rem,6vw,2.4rem);letter-spacing:.3em;color:#fff;}
#pauseScreen p{font-size:.75rem;color:var(--dim);letter-spacing:.12em;}

/* â”€â”€ MAIN OVERLAY â”€â”€ */
#overlay{
  position:fixed;inset:0;z-index:100;background:rgba(4,6,10,.96);
  display:flex;flex-direction:column;align-items:center;justify-content:flex-start;
  opacity:0;pointer-events:none;transition:opacity .3s;
  overflow-y:auto;padding:32px 16px 40px;gap:20px;
}
#overlay.show{opacity:1;pointer-events:all;}
#ov-logo{font-size:clamp(2rem,8vw,3.5rem);font-weight:700;letter-spacing:.4em;color:var(--gold);text-shadow:0 0 40px rgba(255,196,0,.4);}
#ov-title{font-size:clamp(1.1rem,4vw,1.8rem);font-weight:700;letter-spacing:.25em;color:#fff;text-transform:uppercase;text-align:center;}
#ov-subtitle{font-size:.78rem;color:var(--dim);letter-spacing:.1em;text-align:center;}
#ov-result{font-size:clamp(1.8rem,7vw,3.2rem);font-weight:700;letter-spacing:.1em;text-shadow:0 0 60px currentColor;}
#ov-result.green{color:var(--green);}
#ov-result.red{color:var(--red);}

/* stats grid */
#ov-cards{
  display:grid;grid-template-columns:repeat(3,1fr);gap:1px;
  background:var(--border);border:1px solid var(--border);
  width:min(540px,94vw);
}
.ov-card{background:var(--panel);padding:14px 18px;display:flex;flex-direction:column;gap:4px;}
.ov-card-lbl{font-size:.55rem;letter-spacing:.12em;color:var(--dim);text-transform:uppercase;}
.ov-card-val{font-size:clamp(.9rem,2.8vw,1.25rem);font-weight:700;color:#fff;}
.ov-card-val.green{color:var(--green);}
.ov-card-val.red{color:var(--red);}
.ov-card-val.gold{color:var(--gold);}

/* setup fields */
#ov-setup{display:flex;flex-direction:column;gap:12px;width:min(400px,90vw);}
.setup-row{display:flex;align-items:center;justify-content:space-between;gap:12px;}
.setup-lbl{font-size:.68rem;letter-spacing:.1em;color:var(--dim);text-transform:uppercase;white-space:nowrap;flex-shrink:0;}
.setup-input{
  font-family:'IBM Plex Mono',monospace;font-size:1.1rem;font-weight:700;
  background:#111827;border:1px solid var(--border);color:#fff;
  padding:10px 16px;border-radius:3px;width:190px;outline:none;text-align:right;
  touch-action:manipulation;
}
.setup-input:focus{border-color:var(--gold);}
#ov-balance-input{color:var(--gold);}

/* challenges â€” compact list */
#ov-challenges{display:flex;flex-direction:column;gap:8px;width:min(400px,90vw);max-height:240px;overflow-y:auto;scrollbar-width:thin;scrollbar-color:var(--border) transparent;}
.challenge-lbl{font-size:.62rem;letter-spacing:.14em;color:var(--dim);text-transform:uppercase;}
#challengesList{display:flex;flex-direction:column;gap:4px;}
.ch-btn{
  font-family:'IBM Plex Mono',monospace;font-size:.75rem;font-weight:600;
  background:var(--panel);border:1px solid var(--border);color:var(--text);
  padding:9px 14px;border-radius:3px;cursor:pointer;text-align:left;
  transition:border-color .1s,background .1s;touch-action:manipulation;
  display:flex;align-items:center;justify-content:space-between;gap:8px;
}
.ch-btn:active{background:#1a2235;}
.ch-btn.selected{border-color:var(--gold);background:rgba(255,196,0,.07);}
.ch-name{color:#fff;letter-spacing:.04em;}
.ch-goal{color:var(--gold);font-size:.68rem;white-space:nowrap;}

/* buttons row */
#ov-buttons{display:flex;flex-direction:column;align-items:center;gap:10px;width:min(400px,90vw);}
#ov-btn{
  font-family:'IBM Plex Mono',monospace;font-size:.95rem;font-weight:700;
  letter-spacing:.15em;text-transform:uppercase;
  background:var(--gold);color:#000;border:none;
  padding:15px 0;border-radius:3px;cursor:pointer;
  transition:transform .1s,opacity .1s;
  touch-action:manipulation;width:100%;text-align:center;
}
#ov-btn:active{opacity:.85;transform:scale(.98);}
#ov-play-btn{
  font-family:'IBM Plex Mono',monospace;font-size:.82rem;font-weight:700;
  letter-spacing:.12em;text-transform:uppercase;
  background:transparent;color:var(--dim);border:1px solid var(--border);
  padding:11px 0;border-radius:3px;cursor:pointer;
  touch-action:manipulation;width:100%;text-align:center;
}
#ov-play-btn:active{background:#111827;color:#fff;}
#ov-click-hint{font-size:.58rem;color:#2a3a50;letter-spacing:.1em;}

/* GOAL TOAST */
#goalToast{
  position:fixed;top:60px;left:50%;transform:translateX(-50%);
  z-index:150;background:var(--gold);color:#000;
  font-family:'IBM Plex Mono',monospace;font-weight:700;font-size:1rem;
  letter-spacing:.15em;padding:12px 28px;border-radius:4px;
  text-align:center;opacity:0;pointer-events:none;
  transition:opacity .3s;white-space:nowrap;
  box-shadow:0 0 40px rgba(255,196,0,.6);
}
#goalToast.show{opacity:1;}

/* LOADING */
#loading{
  position:fixed;inset:0;z-index:200;background:var(--bg);
  display:flex;flex-direction:column;align-items:center;justify-content:center;gap:16px;
}
#loading.hide{display:none;}
#loading-text{font-size:.78rem;letter-spacing:.2em;color:var(--dim);}
#loading-bar{width:200px;height:2px;background:var(--border);border-radius:1px;overflow:hidden;}
#loading-fill{height:100%;background:var(--gold);width:0%;transition:width .2s;}
#loading-error{font-size:.72rem;color:var(--red);letter-spacing:.08em;max-width:340px;text-align:center;display:none;line-height:1.6;}
</style>
</head>
<body>

<!-- LOADING -->
<div id="loading">
  <div style="font-size:1.5rem;font-weight:700;letter-spacing:.4em;color:var(--gold)">TRADER</div>
  <div id="loading-text">LOADING STOCKS...</div>
  <div id="loading-bar"><div id="loading-fill"></div></div>
  <div id="loading-error"></div>
</div>

<!-- APP SHELL -->
<div id="app">

  <!-- TOP BAR -->
  <div id="topbar">
    <div id="timerFill" style="width:100%"></div>
    <div id="stockBadge">
      <span id="stockTag">â€”</span>
      <span id="livePrice">â€”</span>
      <span id="livePriceDelta"></span>
    </div>
    <div id="topRight">
      <button class="ctrl-btn" id="pauseBtn" onclick="togglePause(event)">â¸ PAUSE</button>
      <button class="ctrl-btn" id="restartBtn" onclick="goToMenu(event)">â†º RESTART</button>
      <span id="timerPill">30</span>
    </div>
  </div>

  <!-- HUD: two scrollable rows -->
  <div id="hud">
    <div class="hud-row">
      <div class="hud-cell"><span class="hud-lbl">Balance</span><span class="hud-val" id="hBalance">â€”</span></div>
      <div class="hud-cell"><span class="hud-lbl">Bal. Short</span><span class="hud-val" id="hBalanceShort">â€”</span></div>
      <div class="hud-cell"><span class="hud-lbl">Round P&amp;L</span><span class="hud-val" id="hRoundPnl">â€”</span></div>
      <div class="hud-cell"><span class="hud-lbl">Session P&amp;L</span><span class="hud-val" id="hPnl">â€”</span></div>
      <div class="hud-cell"><span class="hud-lbl">Goal Progress</span><span class="hud-val" id="hGoalPct">â€”</span></div>
    </div>
    <div class="hud-row">
      <div class="hud-cell"><span class="hud-lbl">Open P&amp;L</span><span class="hud-val" id="hOpen">â€”</span></div>
      <div class="hud-cell"><span class="hud-lbl">Time</span><span class="hud-val" id="hSessionTime">00:00</span></div>
      <div class="hud-cell"><span class="hud-lbl">Round</span><span class="hud-val" id="hRound">â€”</span></div>
      <div class="hud-cell"><span class="hud-lbl">Stock</span><span class="hud-val" id="hStock" style="color:var(--gold)">â€”</span></div>
    </div>
  </div>

  <!-- CHARTS -->
  <div id="chartsArea">
    <div id="mainWrap">
      <canvas id="mainChart"></canvas>
      <div class="chart-label" id="mainLabel">â€”</div>
      <div id="tradeFlash"></div>
      <div id="holdingBar">â— LONG POSITION OPEN</div>
      <div id="hint">HOLD TO BUY Â· RELEASE TO SELL</div>
    </div>
    <div id="equityWrap">
      <canvas id="equityChart"></canvas>
      <div class="chart-label">PORTFOLIO VALUE</div>
    </div>
  </div>

</div><!-- /app -->

<!-- GOAL TOAST -->
<div id="goalToast">ğŸ‰ GOAL REACHED!</div>

<!-- PAUSE SCREEN -->
<div id="pauseScreen">
  <h2>PAUSED</h2>
  <p>TAP ANYWHERE TO RESUME</p>
</div>

<!-- MAIN OVERLAY -->
<div id="overlay" class="show">
  <div id="ov-logo">TRADER</div>
  <div id="ov-title">READY TO TRADE</div>
  <div id="ov-subtitle">Set your goal â€” or just play</div>
  <div id="ov-result" style="display:none"></div>

  <!-- Stats grid (after round 1) -->
  <div id="ov-cards" style="display:none">
    <div class="ov-card"><span class="ov-card-lbl">Balance</span><span class="ov-card-val" id="ov-balance">â€”</span></div>
    <div class="ov-card"><span class="ov-card-lbl">Round P&amp;L</span><span class="ov-card-val" id="ov-roundpnl">â€”</span></div>
    <div class="ov-card"><span class="ov-card-lbl">Session P&amp;L</span><span class="ov-card-val" id="ov-pnl">â€”</span></div>
    <div class="ov-card"><span class="ov-card-lbl">Goal Progress</span><span class="ov-card-val" id="ov-goalpct">â€”</span></div>
    <div class="ov-card"><span class="ov-card-lbl">Next Stock</span><span class="ov-card-val gold" id="ov-stock">â€”</span></div>
    <div class="ov-card"><span class="ov-card-lbl">Round</span><span class="ov-card-val" id="ov-round">1</span></div>
  </div>

  <!-- Setup fields (first round) -->
  <div id="ov-setup">
    <div class="setup-row">
      <span class="setup-lbl">Starting Balance $</span>
      <input class="setup-input" id="ov-balance-input" type="text" inputmode="decimal" placeholder="100" onclick="event.stopPropagation()"/>
    </div>
    <div class="setup-row">
      <span class="setup-lbl">Balance Goal $</span>
      <input class="setup-input" id="ov-goal-input" type="text" inputmode="decimal" placeholder="200.00" onclick="event.stopPropagation()"/>
    </div>
  </div>

  <!-- Buttons (below subtitle on first screen) -->
  <div id="ov-buttons">
    <button id="ov-btn" onclick="event.stopPropagation();startFromOverlay()">START ROUND 1</button>
    <button id="ov-play-btn" onclick="event.stopPropagation();quickPlay()" style="display:none">â–¶ JUST PLAY (no goal)</button>
    <div id="ov-click-hint">TAP ANYWHERE TO BEGIN</div>
  </div>

  <!-- Challenges list (first round) â€” scrollable -->
  <div id="ov-challenges">
    <div class="challenge-lbl">â€” OR PICK A CHALLENGE â€”</div>
    <div id="challengesList"></div>
  </div>
</div>

<script>
'use strict';

// â”€â”€â”€ CHALLENGES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const CHALLENGES = [
  { name:'âš¡ Quick Flip',   goal:200,              balance:100,   label:'$200' },
  { name:'ğŸª™ Millionaire',  goal:1000000,          balance:100,   label:'$1MM' },
  { name:'ğŸ¦ Billionaire',  goal:1000000000,       balance:100,   label:'$1B' },
  { name:'ğŸ‡µğŸ‡± Poland GDP',  goal:880000000000,     balance:100,   label:'$880B' },
  { name:'ğŸ‡©ğŸ‡ª Germany GDP', goal:4600000000000,    balance:100,   label:'$4.6T' },
  { name:'ğŸ‡¨ğŸ‡³ China GDP',   goal:18500000000000,   balance:100,   label:'$18.5T' },
  { name:'ğŸ‡ºğŸ‡¸ US GDP',      goal:29000000000000,   balance:100,   label:'$29T' },
  { name:'ğŸš€ Moon Shot',    goal:1000000000,       balance:1,     label:'$1B from $1' },
  { name:'ğŸ’¼ Hedge Fund',   goal:10000000000,      balance:10000, label:'$10B from $10K' },
];

// â”€â”€â”€ HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const fmt = n => '$' + Math.abs(n).toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2});
const fmtFull = n => { const sign=n<0?'-':''; return sign+'$'+Math.abs(n).toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2}); };
function fmtS(n){
  const a=Math.abs(n);
  // If value has 2+ digits before decimal, show 0 decimals; else 1 decimal
  const decimals=a>=10?0:1;
  return '$'+a.toLocaleString('en-US',{minimumFractionDigits:decimals,maximumFractionDigits:decimals});
}
const signed = n => (n>=0?'+':'-') + fmt(n);
const signedPct = n => (n>=0?'+':'') + n.toFixed(2) + '%';

function fmtShort(n) {
  const sign=n<0?'-':''; const a=Math.abs(n);
  if(a>=1e12) return sign+'$'+(a/1e12).toFixed(2)+'T';
  if(a>=1e9)  return sign+'$'+(a/1e9).toFixed(2)+'B';
  if(a>=1e6)  return sign+'$'+(a/1e6).toFixed(2)+'MM';
  if(a>=1e3)  return sign+'$'+(a/1e3).toFixed(1)+'K';
  return sign+'$'+a.toFixed(2);
}

function hexRgb(h){ return `${parseInt(h.slice(1,3),16)},${parseInt(h.slice(3,5),16)},${parseInt(h.slice(5,7),16)}`; }

function fmtDate(str){
  if(!str) return '';
  const d=new Date(str+'T12:00:00');
  return d.toLocaleDateString('en-US',{month:'short',year:'numeric'});
}

function parseInputNum(id){
  const raw=(document.getElementById(id).value||'').replace(/,/g,'').trim();
  const v=parseFloat(raw);
  return isNaN(v)?null:v;
}

// â”€â”€â”€ CSV PARSER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function parseYahooCSV(text) {
  const lines=text.trim().split('\n').map(l=>l.trim()).filter(Boolean);
  if(lines.length<2) throw new Error('CSV too short');
  const sep=lines[0].includes('\t')?'\t':',';
  const rawHeaders=lines[0].split(sep).map(h=>h.trim().replace(/"/g,'').toLowerCase());
  let dateIdx=rawHeaders.findIndex(h=>h==='date'); if(dateIdx===-1) dateIdx=0;
  let closeIdx=rawHeaders.findIndex(h=>h==='adj close');
  if(closeIdx===-1) closeIdx=rawHeaders.findIndex(h=>h.includes('close'));
  if(closeIdx===-1) throw new Error('No Close column. Headers: '+rawHeaders.join(', '));
  function normalizeDate(s){
    s=(s||'').trim().replace(/"/g,''); if(!s) return null;
    if(/^\d{4}-\d{2}-\d{2}/.test(s)) return s.slice(0,10);
    if(/^\d{1,2}\/\d{1,2}\/\d{2,4}$/.test(s)){
      const[m,d,y]=s.split('/');
      const year=y.length===2?(parseInt(y)>30?'19'+y:'20'+y):y;
      return year+'-'+m.padStart(2,'0')+'-'+d.padStart(2,'0');
    }
    return null;
  }
  const prices=[],dates=[];
  for(let i=1;i<lines.length;i++){
    const cols=lines[i].split(sep);
    if(cols.length<=Math.max(dateIdx,closeIdx)) continue;
    const dateStr=normalizeDate(cols[dateIdx]); if(!dateStr) continue;
    const price=parseFloat((cols[closeIdx]||'').trim().replace(/"/g,''));
    if(isNaN(price)||price<=0) continue;
    dates.push(dateStr); prices.push(Math.round(price*100)/100);
  }
  if(prices.length<10) throw new Error('Only '+prices.length+' rows. First: '+lines[1]);
  return{prices,dates};
}

// â”€â”€â”€ STOCK POOL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const STOCK_COLORS=['#4a9eff','#f5a623','#76ff03','#e879f9','#fb923c','#60a5fa','#34d399','#f472b6','#a78bfa','#fbbf24','#38bdf8','#4ade80'];
let STOCK_POOL=[], SYMS=[];

async function loadStocks(){
  const loadingEl=document.getElementById('loading');
  const loadingText=document.getElementById('loading-text');
  const loadingFill=document.getElementById('loading-fill');
  const loadingErr=document.getElementById('loading-error');
  try{
    loadingText.textContent='FETCHING STOCK LIST...';
    const listRes=await fetch('/stocks/index.json');
    if(!listRes.ok) throw new Error('Could not load /stocks/index.json (HTTP '+listRes.status+')');
    const stocks=await listRes.json();
    if(!Array.isArray(stocks)||stocks.length===0) throw new Error('index.json is empty');
    for(let i=0;i<stocks.length;i++){
      const sym=stocks[i];
      loadingText.textContent='LOADING '+sym+'... ('+(i+1)+'/'+stocks.length+')';
      loadingFill.style.width=((i+1)/stocks.length*100)+'%';
      try{
        const csvRes=await fetch('/stocks/'+encodeURIComponent(sym)+'.csv');
        if(!csvRes.ok) throw new Error('HTTP '+csvRes.status);
        const{prices,dates}=parseYahooCSV(await csvRes.text());
        STOCK_POOL.push({sym,name:sym,color:STOCK_COLORS[i%STOCK_COLORS.length],prices,dates});
      }catch(e){ console.warn('Skipping '+sym+':',e.message); }
    }
    if(STOCK_POOL.length===0) throw new Error('All CSVs failed to parse');
    SYMS=STOCK_POOL.map(s=>s.sym);
    loadingEl.classList.add('hide');
    init();
  }catch(e){
    loadingText.textContent='ERROR';
    loadingErr.style.display='block';
    loadingErr.textContent=e.message;
  }
}

// â”€â”€â”€ CONSTANTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const TOTAL=200, ROUND_MS=30000, TICK_MS=ROUND_MS/TOTAL;

// â”€â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let balance=100, initialBalance=100, totalPnL=0, roundNum=0;
let holding=false, entryPrice=null, entryIdx=null;
let revealed=0, roundStart=null, running=false, paused=false;
let currentSym='', PRICES=[], DATES=[], equityCurve=[100];
let balanceAtRoundStart=100, tickHandle=null;
let goalAmount=0, goalToastShown=false;
let sessionStart=null, sessionTimerHandle=null;
let pauseStart=null, totalPauseMs=0;

// â”€â”€â”€ ZOOM / CAMERA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let zoomLevel=1.0, zoomTarget=1.0;
const ZOOM_LERP=0.015, ZOOM_MIN=0.25, ZOOM_MAX=1.00;
let camShift=0, camShiftTarget=0;
const CAM_LERP=0.08, CAM_AHEAD=14, CAM_STRENGTH=0.30;

// â”€â”€â”€ CANVAS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const mainCanvas=document.getElementById('mainChart');
const equityCanvas=document.getElementById('equityChart');
const mCtx=mainCanvas.getContext('2d');
const eCtx=equityCanvas.getContext('2d');
const mW=()=>mainCanvas.offsetWidth;
const mH=()=>mainCanvas.offsetHeight;
const eW=()=>equityCanvas.offsetWidth;
const eH=()=>equityCanvas.offsetHeight;

function resizeCanvas(canvas,ctx){
  const dpr=window.devicePixelRatio||1;
  canvas.width=canvas.offsetWidth*dpr;
  canvas.height=canvas.offsetHeight*dpr;
  ctx.setTransform(1,0,0,1,0,0);
  ctx.scale(dpr,dpr);
}
function resizeAll(){ resizeCanvas(mainCanvas,mCtx); resizeCanvas(equityCanvas,eCtx); drawMain(); drawEquity(); }
window.addEventListener('resize',resizeAll);

function updateSessionTimer(){
  if(!sessionStart) return;
  const el=document.getElementById('hSessionTime');
  const s=Math.floor((Date.now()-sessionStart-totalPauseMs)/1000);
  el.textContent=String(Math.floor(s/60)).padStart(2,'0')+':'+String(s%60).padStart(2,'0');
}

// â”€â”€â”€ ZOOM / CAMERA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateZoom(){
  if(revealed<10) return;
  const recent=PRICES.slice(Math.max(0,revealed-20),revealed);
  const lo=Math.min(...recent),hi=Math.max(...recent);
  const volPct=(hi-lo)/((lo+hi)/2||1);
  zoomTarget=ZOOM_MAX-(Math.max(0,Math.min(1,(volPct-0.01)/0.07)))*(ZOOM_MAX-ZOOM_MIN);
  zoomLevel+=(zoomTarget-zoomLevel)*ZOOM_LERP;
}
function updateCamera(){
  if(revealed>1&&revealed<=PRICES.length-CAM_AHEAD){
    const cur=PRICES[revealed-1],ahead=PRICES[revealed-1+CAM_AHEAD];
    const lookback=PRICES.slice(Math.max(0,revealed-30),revealed);
    const lo=Math.min(...lookback),hi=Math.max(...lookback);
    camShiftTarget=Math.max(-1,Math.min(1,(ahead-cur)/((hi-lo||1)*0.5)));
  }else{ camShiftTarget=0; }
  camShift+=(camShiftTarget-camShift)*CAM_LERP;
}

// â”€â”€â”€ DRAW MAIN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function drawMain(){
  const w=mW(),h=mH();
  mCtx.clearRect(0,0,w,h);
  if(revealed<2) return;
  const VISIBLE=Math.max(20,Math.round(TOTAL*zoomLevel));
  const allRevealed=PRICES.slice(0,revealed);
  const allDates=DATES.slice(0,revealed);
  const visible=allRevealed.slice(Math.max(0,allRevealed.length-VISIBLE));
  const vdates=allDates.slice(Math.max(0,allDates.length-VISIBLE));

  const clipTop=h*0.10, clipBot=h*0.90, clipH=clipBot-clipTop;
  const padR=62, padB=22;
  const cW=w-padR, padT=clipTop, cH=clipH-padB;

  const minP=Math.min(...visible), maxP=Math.max(...visible);
  const range=maxP-minP||1, pad=range*0.10;
  const viewShift=camShift*range*CAM_STRENGTH;
  const minPad=minP-pad+viewShift, maxPad=maxP+pad+viewShift;

  const xOf=i=>(i/(VISIBLE-1))*cW;
  const yOf=p=>padT+cH-((p-minPad)/(maxPad-minPad))*cH;
  const clampY=y=>Math.max(clipTop,Math.min(padT+cH,y));
  const startSlot=VISIBLE-visible.length;
  const sc=STOCK_POOL.find(s=>s.sym===currentSym)?.color||'#4a9eff';

  mCtx.save();
  mCtx.beginPath(); mCtx.rect(0,clipTop,cW+padR,clipH); mCtx.clip();

  // Grid
  mCtx.strokeStyle='rgba(255,255,255,0.035)'; mCtx.lineWidth=1;
  for(let i=0;i<=5;i++){
    const y=padT+(i/5)*cH;
    mCtx.beginPath(); mCtx.moveTo(0,y); mCtx.lineTo(cW,y); mCtx.stroke();
  }

  const pts=visible.map((p,i)=>({x:xOf(startSlot+i),y:clampY(yOf(p))}));
  const last=pts[pts.length-1];

  // Fill
  mCtx.beginPath();
  pts.forEach((pt,i)=>{
    if(i===0) mCtx.moveTo(pt.x,pt.y);
    else{ mCtx.lineTo(pt.x,pts[i-1].y); mCtx.lineTo(pt.x,pt.y); }
  });
  mCtx.lineTo(last.x,padT+cH); mCtx.lineTo(xOf(startSlot),padT+cH); mCtx.closePath();
  const g=mCtx.createLinearGradient(0,padT,0,padT+cH);
  const rgb=hexRgb(holding?'#00e676':sc);
  g.addColorStop(0,`rgba(${rgb},0.15)`); g.addColorStop(1,'rgba(0,0,0,0)');
  mCtx.fillStyle=g; mCtx.fill();

  // Line
  const lineCol=holding?'#00e676':sc;
  mCtx.strokeStyle=lineCol; mCtx.lineWidth=1;
  mCtx.shadowColor=lineCol; mCtx.shadowBlur=holding?8:4;
  mCtx.beginPath();
  pts.forEach((pt,i)=>{
    if(i===0) mCtx.moveTo(pt.x,pt.y);
    else{ mCtx.lineTo(pt.x,pts[i-1].y); mCtx.lineTo(pt.x,pt.y); }
  });
  mCtx.stroke(); mCtx.shadowBlur=0;

  // Position line
  if(holding&&entryPrice!=null&&entryIdx!=null){
    const cur=visible[visible.length-1];
    const ic=cur>=entryPrice?'#00e676':'#ff1744';
    const windowStart=Math.max(0,allRevealed.length-VISIBLE);
    const x1=xOf(Math.max(0,startSlot+(entryIdx-windowStart)));
    const y1=clampY(yOf(entryPrice));
    mCtx.save();
    mCtx.strokeStyle=ic; mCtx.lineWidth=1.5; mCtx.shadowColor=ic; mCtx.shadowBlur=8;
    mCtx.setLineDash([4,4]);
    mCtx.beginPath(); mCtx.moveTo(x1,y1); mCtx.lineTo(last.x,last.y); mCtx.stroke();
    mCtx.setLineDash([]); mCtx.shadowBlur=0;
    mCtx.beginPath(); mCtx.arc(x1,y1,4,0,Math.PI*2);
    mCtx.fillStyle=ic; mCtx.shadowColor=ic; mCtx.shadowBlur=12; mCtx.fill(); mCtx.shadowBlur=0;
    mCtx.restore();
    const openPnL=(cur-entryPrice)*(balance/entryPrice);
    mCtx.fillStyle=ic; mCtx.font='700 10px IBM Plex Mono,monospace'; mCtx.textAlign='right';
    mCtx.fillText(signed(openPnL),Math.min((x1+last.x)/2,cW-4),(y1+last.y)/2-8);
  }

  mCtx.restore();

  // Y labels
  mCtx.fillStyle='#aabbcc'; mCtx.font='600 10px IBM Plex Mono,monospace'; mCtx.textAlign='right';
  for(let i=0;i<=5;i++){
    const val=maxPad-(i/5)*(maxPad-minPad);
    const y=padT+(i/5)*cH;
    if(y>=clipTop&&y<=clipBot) mCtx.fillText(fmtS(val),w-4,y+3);
  }

  // X date labels
  mCtx.fillStyle='#8899aa'; mCtx.font='600 8px IBM Plex Mono,monospace'; mCtx.textAlign='center';
  const labelEvery=Math.max(5,Math.round(VISIBLE/8));
  vdates.forEach((d,i)=>{
    if(i%labelEvery===0||i===vdates.length-1)
      mCtx.fillText(fmtDate(d),xOf(startSlot+i),clipBot+16);
  });

  const dotY=clampY(last.y);
  mCtx.beginPath(); mCtx.arc(last.x,dotY,4,0,Math.PI*2);
  mCtx.fillStyle=lineCol; mCtx.shadowColor=lineCol; mCtx.shadowBlur=16; mCtx.fill(); mCtx.shadowBlur=0;

  const d0=vdates[0],d1=vdates[vdates.length-1];
  document.getElementById('mainLabel').textContent=
    currentSym+'  Â·  '+(d0?fmtDate(d0):'')+
    (d1&&d1!==d0?' â€“ '+fmtDate(d1):'')+' Â· '+VISIBLE+' bars';
}

// â”€â”€â”€ DRAW EQUITY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function drawEquity(){
  const w=eW(),h=eH();
  eCtx.clearRect(0,0,w,h);
  if(equityCurve.length<2) return;
  const padR=62,padT=10,padB=8;
  const cW=w-padR,cH=h-padT-padB;
  const n=equityCurve.length;
  const minV=Math.min(...equityCurve)*0.995,maxV=Math.max(...equityCurve)*1.005;
  const xOf=i=>(i/Math.max(n-1,1))*cW;
  const yOf=v=>padT+cH-((v-minV)/((maxV-minV)||1))*cH;
  const lastVal=equityCurve[n-1];
  const lc=lastVal>=initialBalance?'#00e676':'#ff1744';

  eCtx.strokeStyle='rgba(255,255,255,0.04)'; eCtx.lineWidth=1;
  for(let i=0;i<=2;i++){
    const y=padT+(i/2)*cH;
    eCtx.beginPath(); eCtx.moveTo(0,y); eCtx.lineTo(cW,y); eCtx.stroke();
  }
  eCtx.fillStyle='#aabbcc'; eCtx.font='600 10px IBM Plex Mono,monospace'; eCtx.textAlign='right';
  for(let i=0;i<=2;i++)
    eCtx.fillText(fmtS(maxV-(i/2)*(maxV-minV)),w-4,padT+(i/2)*cH+3);

  const refY=yOf(initialBalance);
  eCtx.save(); eCtx.setLineDash([3,6]);
  eCtx.strokeStyle='rgba(255,255,255,0.1)';
  eCtx.beginPath(); eCtx.moveTo(0,refY); eCtx.lineTo(cW,refY); eCtx.stroke();
  eCtx.restore();
  eCtx.fillStyle='#8899aa'; eCtx.font='600 10px IBM Plex Mono,monospace'; eCtx.textAlign='left';
  eCtx.fillText(fmtShort(initialBalance),4,refY-3);

  eCtx.beginPath();
  equityCurve.forEach((v,i)=>{const x=xOf(i),y=yOf(v);i===0?eCtx.moveTo(x,y):eCtx.lineTo(x,y);});
  eCtx.lineTo(xOf(n-1),h+5); eCtx.lineTo(0,h+5); eCtx.closePath();
  const eg=eCtx.createLinearGradient(0,padT,0,h);
  eg.addColorStop(0,lastVal>=initialBalance?'rgba(0,230,118,0.2)':'rgba(255,23,68,0.2)');
  eg.addColorStop(1,'rgba(0,0,0,0)');
  eCtx.fillStyle=eg; eCtx.fill();

  eCtx.beginPath();
  equityCurve.forEach((v,i)=>{const x=xOf(i),y=yOf(v);i===0?eCtx.moveTo(x,y):eCtx.lineTo(x,y);});
  eCtx.strokeStyle=lc; eCtx.lineWidth=1.5; eCtx.shadowColor=lc; eCtx.shadowBlur=5;
  eCtx.stroke(); eCtx.shadowBlur=0;

  const dotX=xOf(n-1),dotY=yOf(lastVal);
  eCtx.beginPath(); eCtx.arc(dotX,dotY,3,0,Math.PI*2);
  eCtx.fillStyle=lc; eCtx.shadowColor=lc; eCtx.shadowBlur=8; eCtx.fill(); eCtx.shadowBlur=0;
  eCtx.fillStyle=lc; eCtx.font='700 10px IBM Plex Mono,monospace'; eCtx.textAlign='left';
  eCtx.fillText(fmtShort(lastVal),dotX+6,dotY+4);
  eCtx.fillStyle='#8899aa'; eCtx.font='600 10px IBM Plex Mono,monospace';
  eCtx.fillText('Round '+roundNum,6,padT+cH+8);
}

// â”€â”€â”€ TIMER / HUD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateTimer(){
  const rem=Math.max(0,ROUND_MS-(Date.now()-roundStart-totalPauseMs));
  document.getElementById('timerFill').style.width=(rem/ROUND_MS*100)+'%';
  const secs=Math.ceil(rem/1000);
  document.getElementById('timerPill').textContent=secs;
  const urgent=secs<=8;
  document.getElementById('timerPill').className=urgent?'urgent':'';
  document.getElementById('timerFill').className=urgent?'urgent':'';
}

function updateHUD(){
  const cur=revealed>0?PRICES[revealed-1]:null;
  const prev=revealed>1?PRICES[revealed-2]:null;

  document.getElementById('hBalance').textContent=fmtFull(balance);
  document.getElementById('hBalanceShort').textContent=fmtShort(balance);
  document.getElementById('hRound').textContent=roundNum;
  document.getElementById('hStock').textContent=currentSym;
  document.getElementById('stockTag').textContent=currentSym;
  if(cur){
    document.getElementById('livePrice').textContent=fmt(cur);
    if(prev){
      const delta=cur-prev,pctD=(delta/prev)*100;
      const el=document.getElementById('livePriceDelta');
      el.textContent=(delta>=0?'â–²':'â–¼')+Math.abs(pctD).toFixed(2)+'%';
      el.style.color=delta>=0?'var(--green)':'var(--red)';
    }
  }

  const roundPnL=+(balance-balanceAtRoundStart).toFixed(2);
  const rpEl=document.getElementById('hRoundPnl');
  rpEl.textContent=roundPnL!==0?signed(roundPnL):'â€”';
  rpEl.className='hud-val '+(roundPnL>0?'green':roundPnL<0?'red':'');

  const pnlEl=document.getElementById('hPnl');
  pnlEl.textContent=totalPnL!==0?signed(totalPnL):'â€”';
  pnlEl.className='hud-val '+(totalPnL>0?'green':totalPnL<0?'red':'');

  const gEl=document.getElementById('hGoalPct');
  if(goalAmount>0){
    const gPct=(balance/goalAmount)*100;
    gEl.textContent=gPct.toFixed(2)+'% of goal';
    gEl.className='hud-val '+(gPct>=100?'green':gPct>=50?'':'red');
    if(gPct>=100&&!goalToastShown){ goalToastShown=true; showGoalToast(); }
  }else{ gEl.textContent='no goal'; gEl.className='hud-val'; }

  const oEl=document.getElementById('hOpen');
  if(holding&&entryPrice&&cur){
    const u=(cur-entryPrice)*(balance/entryPrice);
    oEl.textContent=signed(u);
    oEl.className='hud-val '+(u>=0?'green':'red');
  }else{ oEl.textContent='â€”'; oEl.className='hud-val'; }

  updateSessionTimer();
}

function showGoalToast(){
  const t=document.getElementById('goalToast');
  t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'),4000);
}

function flashLabel(text,color){
  const el=document.getElementById('tradeFlash');
  el.textContent=text; el.style.color=color; el.style.opacity='1';
  clearTimeout(el._t); el._t=setTimeout(()=>el.style.opacity='0',800);
}

// â”€â”€â”€ TRADING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buy(){
  if(!running||paused||holding||revealed===0) return;
  holding=true; entryPrice=PRICES[revealed-1]; entryIdx=revealed-1;
  document.getElementById('holdingBar').classList.add('show');
  flashLabel('BUY','#00e676');
  updateHUD(); drawMain();
}
function sell(){
  if(!holding) return;
  const cur=PRICES[Math.min(revealed-1,PRICES.length-1)];
  const shares=balance/entryPrice;
  const profit=+((cur-entryPrice)*shares).toFixed(2);
  balance=+(balance+profit).toFixed(2);
  totalPnL=+(totalPnL+profit).toFixed(2);
  holding=false; entryPrice=null; entryIdx=null;
  document.getElementById('holdingBar').classList.remove('show');
  flashLabel(signed(profit),profit>=0?'#00e676':'#ff1744');
  updateHUD(); drawMain();
}

const mainWrap=document.getElementById('mainWrap');
mainWrap.addEventListener('mousedown',buy);
mainWrap.addEventListener('mouseup',sell);
mainWrap.addEventListener('touchstart',e=>{e.preventDefault();buy();},{passive:false});
mainWrap.addEventListener('touchend',  e=>{e.preventDefault();sell();},{passive:false});

// â”€â”€â”€ PAUSE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function togglePause(e){
  if(e) e.stopPropagation();
  if(!running) return;
  paused=!paused;
  const pauseScreen=document.getElementById('pauseScreen');
  const pauseBtn=document.getElementById('pauseBtn');
  if(paused){
    pauseStart=Date.now();
    clearTimeout(tickHandle);
    pauseScreen.classList.add('show');
    pauseBtn.textContent='â–¶ RESUME'; pauseBtn.classList.add('paused');
    clearInterval(sessionTimerHandle);
  }else{
    totalPauseMs+=Date.now()-pauseStart;
    roundStart+=Date.now()-pauseStart;
    pauseScreen.classList.remove('show');
    pauseBtn.textContent='â¸ PAUSE'; pauseBtn.classList.remove('paused');
    sessionTimerHandle=setInterval(updateSessionTimer,1000);
    tick();
  }
}
document.getElementById('pauseScreen').addEventListener('click',()=>{ if(paused) togglePause(); });

// â”€â”€â”€ RESTART â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function goToMenu(e){
  if(e) e.stopPropagation();
  running=false; paused=false;
  clearTimeout(tickHandle); clearInterval(sessionTimerHandle);
  if(holding) sell();
  balance=100; initialBalance=100; totalPnL=0; roundNum=0;
  equityCurve=[100]; goalAmount=0; goalToastShown=false; currentSym='';
  sessionStart=null; totalPauseMs=0;
  document.getElementById('pauseScreen').classList.remove('show');
  document.getElementById('pauseBtn').textContent='â¸ PAUSE';
  document.getElementById('pauseBtn').classList.remove('paused');
  document.getElementById('hSessionTime').textContent='00:00';
  document.getElementById('ov-balance-input').value='';
  document.getElementById('ov-goal-input').value='';
  document.querySelectorAll('.ch-btn').forEach(b=>b.classList.remove('selected'));
  showOverlay(true,0);
}

// â”€â”€â”€ OVERLAY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const overlay=document.getElementById('overlay');

function showOverlay(isFirst,roundPnL){
  const cardsEl=document.getElementById('ov-cards');
  const setupEl=document.getElementById('ov-setup');
  const challengesEl=document.getElementById('ov-challenges');
  const resultEl=document.getElementById('ov-result');
  const logoEl=document.getElementById('ov-logo');
  const playBtn=document.getElementById('ov-play-btn');

  if(isFirst){
    resultEl.style.display='none';
    cardsEl.style.display='none';
    setupEl.style.display='flex';
    challengesEl.style.display='flex';
    logoEl.style.display='block';
    playBtn.style.display='block';
    document.getElementById('ov-title').textContent='READY TO TRADE';
    document.getElementById('ov-subtitle').textContent='Set your goal â€” or just play';
    document.getElementById('ov-btn').textContent='START ROUND 1';
  }else{
    resultEl.style.display='block';
    cardsEl.style.display='grid';
    setupEl.style.display='none';
    challengesEl.style.display='none';
    logoEl.style.display='none';
    playBtn.style.display='none';

    const roundPct=(roundPnL/balanceAtRoundStart)*100;
    resultEl.textContent=(roundPnL>=0?'+':'')+roundPct.toFixed(2)+'%';
    resultEl.className=roundPnL>=0?'green':'red';
    document.getElementById('ov-title').textContent='ROUND COMPLETE';
    document.getElementById('ov-subtitle').textContent=roundPnL>=0?'Nice trade.':'Better luck next time.';

    document.getElementById('ov-balance').textContent=fmtFull(balance);
    document.getElementById('ov-balance').className='ov-card-val'+(balance>=initialBalance?'':' red');
    document.getElementById('ov-roundpnl').textContent=signed(roundPnL);
    document.getElementById('ov-roundpnl').className='ov-card-val '+(roundPnL>=0?'green':'red');
    document.getElementById('ov-pnl').textContent=signed(totalPnL);
    document.getElementById('ov-pnl').className='ov-card-val '+(totalPnL>=0?'green':'red');

    const gEl=document.getElementById('ov-goalpct');
    if(goalAmount>0){
      const gPct=(balance/goalAmount)*100;
      gEl.textContent=gPct.toFixed(2)+'% of goal';
      gEl.className='ov-card-val '+(gPct>=100?'green':gPct>50?'':'red');
    }else{ gEl.textContent='â€”'; gEl.className='ov-card-val'; }

    pickNextStock();
    document.getElementById('ov-stock').textContent=currentSym;
    document.getElementById('ov-round').textContent=roundNum+1;
    document.getElementById('ov-btn').textContent='NEXT ROUND â†’';
  }
  overlay.classList.add('show');
}

function hideOverlay(){ overlay.classList.remove('show'); }

function startFromOverlay(){
  if(roundNum===0){
    const b=parseInputNum('ov-balance-input');
    if(b!=null&&b>=0.01&&b<=1000000){
      balance=Math.round(b*100)/100;
      initialBalance=balance;
      equityCurve=[balance];
    }
    const g=parseInputNum('ov-goal-input');
    if(g!=null&&g>balance) goalAmount=g; // goal = target balance, must be > starting balance
    pickNextStock();
  }
  hideOverlay();
  startRound();
}

function quickPlay(){
  // Start immediately with defaults, no goal
  goalAmount=0;
  if(roundNum===0) pickNextStock();
  hideOverlay();
  startRound();
}

overlay.addEventListener('click',e=>{
  if(e.target===overlay||e.target.id==='ov-click-hint'){
    startFromOverlay();
  }
});

// â”€â”€â”€ CHALLENGES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildChallenges(){
  const list=document.getElementById('challengesList');
  CHALLENGES.forEach(ch=>{
    const btn=document.createElement('button');
    btn.className='ch-btn';
    btn.innerHTML=`<span class="ch-name">${ch.name}</span><span class="ch-goal">Reach ${ch.label} Â· Start ${fmtShort(ch.balance)}</span>`;
    btn.addEventListener('click',e=>{
      e.stopPropagation();
      document.querySelectorAll('.ch-btn').forEach(b=>b.classList.remove('selected'));
      btn.classList.add('selected');
      document.getElementById('ov-goal-input').value=ch.goal;
      document.getElementById('ov-balance-input').value=ch.balance;
    });
    list.appendChild(btn);
  });
}

// â”€â”€â”€ ROUND FLOW â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function pickNextStock(){
  const others=SYMS.filter(s=>s!==currentSym);
  const pool=others.length>0?others:SYMS;
  const chosen=pool[Math.floor(Math.random()*pool.length)];
  const sd=STOCK_POOL.find(s=>s.sym===chosen);
  currentSym=chosen;
  const maxStart=sd.prices.length-TOTAL;
  const start=maxStart>0?Math.floor(Math.random()*maxStart):0;
  PRICES=sd.prices.slice(start,start+TOTAL);
  DATES=sd.dates.slice(start,start+TOTAL);
  revealed=0; holding=false; entryPrice=null; entryIdx=null;
  camShift=0; camShiftTarget=0; zoomLevel=1.0; zoomTarget=1.0;
  balanceAtRoundStart=balance;
}

function startRound(){
  if(!sessionStart){
    sessionStart=Date.now(); totalPauseMs=0;
    sessionTimerHandle=setInterval(updateSessionTimer,1000);
  }
  roundNum++; running=true; paused=false;
  roundStart=Date.now();
  updateHUD(); tick();
}

function endRound(){
  running=false; clearTimeout(tickHandle);
  if(holding) sell();
  const roundPnL=+(balance-balanceAtRoundStart).toFixed(2);
  setTimeout(()=>showOverlay(false,roundPnL),400);
}

function tick(){
  if(paused) return;
  const elapsed=Date.now()-roundStart-totalPauseMs;
  if(elapsed>=ROUND_MS||revealed>=TOTAL){ endRound(); return; }
  revealed++;
  updateZoom(); updateCamera();
  equityCurve.push(balance);
  updateTimer(); updateHUD(); drawMain(); drawEquity();
  const nextTick=roundStart+totalPauseMs+(revealed*TICK_MS)-Date.now();
  tickHandle=setTimeout(tick,Math.max(0,nextTick));
}

// â”€â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function init(){
  buildChallenges();
  resizeAll();
  showOverlay(true,0);
}

loadStocks();
</script>
</body>
</html>
